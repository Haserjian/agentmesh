name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  public-private-guard:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Block private artifacts in PR diff
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          CHANGED="$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")"
          if [ -z "$CHANGED" ]; then
            echo "No changed files."
            exit 0
          fi
          echo "Changed files:"
          echo "$CHANGED"
          git diff --name-only -z "$BASE_SHA" "$HEAD_SHA" | xargs -0 agentmesh classify --fail-on-private

  release-check-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run release-check preview on PR diff
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import subprocess
          from pathlib import Path

          base = os.environ["BASE_SHA"]
          head = os.environ["HEAD_SHA"]
          summary_path = Path(os.environ.get("GITHUB_STEP_SUMMARY", ""))
          changed = subprocess.run(
              ["git", "diff", "--name-only", base, head],
              capture_output=True,
              text=True,
              check=True,
          ).stdout.splitlines()

          out_path = Path(".release-check.json")
          if not changed:
              payload = {"release_check": {"ok": True, "exit_code": 0, "skipped": "no_changed_files"}}
              out_path.write_text(json.dumps(payload, indent=2) + "\n")
              print(out_path.read_text())
              if summary_path:
                  with summary_path.open("a") as f:
                      f.write("### release-check preview (advisory)\n")
                      f.write("- result: `skipped (no changed files)`\n")
              raise SystemExit(0)

          cmd = ["agentmesh", "release-check", "--json", *changed]
          print("Running:", " ".join(cmd))
          proc = subprocess.run(cmd, capture_output=True, text=True)
          stdout = proc.stdout.strip()
          stderr = proc.stderr.strip()
          if stdout:
              print(stdout)
          if stderr:
              print(stderr)

          payload: dict
          if stdout:
              try:
                  payload = json.loads(stdout)
              except json.JSONDecodeError:
                  payload = {"release_check": {"ok": False, "exit_code": proc.returncode, "raw_stdout": stdout}}
          else:
              payload = {"release_check": {"ok": proc.returncode == 0, "exit_code": proc.returncode}}

          release_check = payload.get("release_check", {}) if isinstance(payload, dict) else {}
          if isinstance(release_check, dict):
              release_check.setdefault("exit_code", proc.returncode)
              if stderr:
                  release_check.setdefault("stderr", stderr)
              payload["release_check"] = release_check

          out_path.write_text(json.dumps(payload, indent=2) + "\n")

          rc = int(release_check.get("exit_code", proc.returncode)) if isinstance(release_check, dict) else proc.returncode
          if summary_path:
              with summary_path.open("a") as f:
                  f.write("### release-check preview (advisory)\n")
                  f.write(f"- exit_code: `{rc}`\n")
                  f.write(f"- changed_files: `{len(changed)}`\n")
                  if isinstance(release_check, dict):
                      classification = release_check.get("classification")
                      if isinstance(classification, dict):
                          files = classification.get("files", 0)
                          public = classification.get("public", 0)
                          private = classification.get("private", 0)
                          review = classification.get("review", 0)
                          f.write(
                              f"- classification: files={files}, public={public}, private={private}, review={review}\n"
                          )

          if rc != 0:
              print(
                  f"::warning::release-check preview flagged this diff (exit {rc}); advisory-only in CI."
              )

          raise SystemExit(0)
          PY

      - name: Upload release-check preview artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-check-preview
          path: .release-check.json
          if-no-files-found: warn

  assay-gate:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install assay
        run: pip install "assay-ai>=1.10.1"

      - name: Save baseline on first run
        run: |
          mkdir -p .assay
          if [ ! -f .assay/score-baseline.json ]; then
            echo "No baseline found, saving initial baseline."
            assay gate save-baseline . --json | tee .assay/save-baseline.json
          else
            echo '{"saved": false, "reason": "baseline_exists"}' > .assay/save-baseline.json
          fi

      - name: Run evidence gate
        run: |
          mkdir -p .assay
          assay gate check . --min-score 0 --json | tee .assay/gate-check.json

      - name: Upload gate report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: assay-gate-report
          path: .assay
          if-no-files-found: warn

  assay-verify:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install assay
        run: pip install "assay-ai>=1.10.1"

      - name: Build and verify proof pack
        run: |
          set -euo pipefail
          mkdir -p .assay-verify

          assay run \
            --allow-empty \
            --output ".assay-verify/proof_pack_ci" \
            --json \
            -- python -c "print('agentmesh assay verify canary')" \
            | tee ".assay-verify/run.json"

          assay verify-pack ".assay-verify/proof_pack_ci" --json | tee ".assay-verify/verify.json"

      - name: Upload verify artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: assay-verify-report
          path: .assay-verify
          if-no-files-found: warn

  weave-integrity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Verify weave tamper detection
        env:
          AGENTMESH_DATA_DIR: ${{ github.workspace }}/.agentmesh-ci
          AGENTMESH_AGENT_ID: ci_weave_guard
        run: |
          set -euo pipefail

          agentmesh weave record --trace-id ci.weave.1 | tee -a weave-verify.log
          agentmesh weave record --trace-id ci.weave.2 | tee -a weave-verify.log
          agentmesh weave verify | tee -a weave-verify.log

          python - <<'PY'
          import os
          import sqlite3
          from pathlib import Path

          db_path = Path(os.environ["AGENTMESH_DATA_DIR"]) / "board.db"
          conn = sqlite3.connect(str(db_path))
          try:
              row = conn.execute(
                  "SELECT event_id FROM weave_events ORDER BY created_at DESC LIMIT 1"
              ).fetchone()
              if row is None:
                  raise SystemExit("no weave events to tamper")
              conn.execute(
                  "UPDATE weave_events SET event_hash = ? WHERE event_id = ?",
                  ("sha256:deadbeef", row[0]),
              )
              conn.commit()
          finally:
              conn.close()
          PY

          set +e
          agentmesh weave verify >> weave-verify.log 2>&1
          verify_status=$?
          set -e

          if [ "$verify_status" -eq 0 ]; then
            echo "Expected weave verify to fail after tamper, got success." | tee -a weave-verify.log
            exit 1
          fi
          echo "Tamper detection verified (non-zero exit: $verify_status)." | tee -a weave-verify.log

      - name: Upload weave integrity artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weave-integrity
          path: |
            weave-verify.log
            .agentmesh-ci/events.jsonl
            .agentmesh-ci/board.db

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests
        run: pytest tests/ -q

  package-smoke:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build wheel
        run: |
          pip install build
          python -m build

      - name: Install wheel in clean venv
        run: |
          python -m venv .pkg-venv
          . .pkg-venv/bin/activate
          pip install dist/*.whl

      - name: Smoke test packaged CLI
        run: |
          . .pkg-venv/bin/activate
          agentmesh --version
          agentmesh >/dev/null
          agentmesh doctor --help
          agentmesh mcp --help
          agentmesh orch --help
          agentmesh watchdog --help
