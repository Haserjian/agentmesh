name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  public-private-guard:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Block private artifacts in PR diff
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          CHANGED="$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")"
          if [ -z "$CHANGED" ]; then
            echo "No changed files."
            exit 0
          fi
          echo "Changed files:"
          echo "$CHANGED"
          git diff --name-only -z "$BASE_SHA" "$HEAD_SHA" | xargs -0 agentmesh classify --fail-on-private

  release-check-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run release-check preview on PR diff
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import subprocess
          import sys
          from pathlib import Path

          base = os.environ["BASE_SHA"]
          head = os.environ["HEAD_SHA"]
          changed = subprocess.run(
              ["git", "diff", "--name-only", base, head],
              capture_output=True,
              text=True,
              check=True,
          ).stdout.splitlines()

          out_path = Path(".release-check.json")
          if not changed:
              payload = {"release_check": {"ok": True, "exit_code": 0, "skipped": "no_changed_files"}}
              out_path.write_text(json.dumps(payload, indent=2) + "\n")
              print(out_path.read_text())
              sys.exit(0)

          cmd = ["agentmesh", "release-check", "--json", *changed]
          print("Running:", " ".join(cmd))
          proc = subprocess.run(cmd, capture_output=True, text=True)
          stdout = proc.stdout.strip()
          stderr = proc.stderr.strip()
          if stdout:
              print(stdout)
          if stderr:
              print(stderr, file=sys.stderr)
          out_path.write_text((stdout or "{}") + "\n")
          sys.exit(proc.returncode)
          PY

      - name: Upload release-check preview artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-check-preview
          path: .release-check.json

  assay-gate:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install assay
        run: pip install "assay-ai>=1.10.1"

      - name: Save baseline on first run
        run: |
          if [ ! -f .assay/score-baseline.json ]; then
            echo "No baseline found, saving initial baseline."
            assay gate save-baseline . --json
          fi

      - name: Run evidence gate
        run: assay gate check . --min-score 0 --json

      - name: Upload gate report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: assay-gate-report
          path: .assay/

  assay-verify:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install assay
        run: pip install "assay-ai>=1.10.1"

      - name: Build and verify proof pack
        run: |
          set -euo pipefail
          mkdir -p .assay-verify

          assay run \
            --allow-empty \
            --output ".assay-verify/proof_pack_ci" \
            --json \
            -- python -c "print('agentmesh assay verify canary')" \
            | tee ".assay-verify/run.json"

          assay verify-pack ".assay-verify/proof_pack_ci" --json | tee ".assay-verify/verify.json"

      - name: Upload verify artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: assay-verify-report
          path: .assay-verify/

  weave-integrity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Verify weave tamper detection
        env:
          AGENTMESH_DATA_DIR: ${{ github.workspace }}/.agentmesh-ci
          AGENTMESH_AGENT_ID: ci_weave_guard
        run: |
          set -euo pipefail

          agentmesh weave record --trace-id ci.weave.1 | tee -a weave-verify.log
          agentmesh weave record --trace-id ci.weave.2 | tee -a weave-verify.log
          agentmesh weave verify | tee -a weave-verify.log

          python - <<'PY'
          import os
          import sqlite3
          from pathlib import Path

          db_path = Path(os.environ["AGENTMESH_DATA_DIR"]) / "board.db"
          conn = sqlite3.connect(str(db_path))
          try:
              row = conn.execute(
                  "SELECT event_id FROM weave_events ORDER BY created_at DESC LIMIT 1"
              ).fetchone()
              if row is None:
                  raise SystemExit("no weave events to tamper")
              conn.execute(
                  "UPDATE weave_events SET event_hash = ? WHERE event_id = ?",
                  ("sha256:deadbeef", row[0]),
              )
              conn.commit()
          finally:
              conn.close()
          PY

          set +e
          agentmesh weave verify >> weave-verify.log 2>&1
          verify_status=$?
          set -e

          if [ "$verify_status" -eq 0 ]; then
            echo "Expected weave verify to fail after tamper, got success." | tee -a weave-verify.log
            exit 1
          fi
          echo "Tamper detection verified (non-zero exit: $verify_status)." | tee -a weave-verify.log

      - name: Upload weave integrity artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weave-integrity
          path: |
            weave-verify.log
            .agentmesh-ci/events.jsonl
            .agentmesh-ci/board.db

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests
        run: pytest tests/ -q

  package-smoke:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build wheel
        run: |
          pip install build
          python -m build

      - name: Install wheel in clean venv
        run: |
          python -m venv .pkg-venv
          . .pkg-venv/bin/activate
          pip install dist/*.whl

      - name: Smoke test packaged CLI
        run: |
          . .pkg-venv/bin/activate
          agentmesh --version
          agentmesh >/dev/null
          agentmesh doctor --help
          agentmesh mcp --help
          agentmesh orch --help
          agentmesh watchdog --help
