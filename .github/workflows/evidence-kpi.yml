name: Evidence KPI

on:
  schedule:
    - cron: "17 4 * * *"
  workflow_dispatch:
    inputs:
      days:
        description: "Lookback window in days"
        required: false
        default: "30"
      base:
        description: "Base branch"
        required: false
        default: "main"
      enforcement_date:
        description: "Enforcement start (YYYY-MM-DD or ISO8601)"
        required: false
        default: "2026-02-25T04:40:16Z"

permissions:
  actions: read
  contents: read
  pull-requests: read
  checks: read

jobs:
  evidence-kpi:
    runs-on: ubuntu-latest
    env:
      DEFAULT_ENFORCEMENT_DATE: "2026-02-25T04:40:16Z"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Compute evidence KPI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DAYS="${{ github.event.inputs.days }}"
          BASE="${{ github.event.inputs.base }}"
          ENFORCEMENT_DATE="${{ github.event.inputs.enforcement_date }}"
          if [ -z "$DAYS" ]; then DAYS="30"; fi
          if [ -z "$BASE" ]; then BASE="main"; fi
          if [ -z "$ENFORCEMENT_DATE" ]; then ENFORCEMENT_DATE="$DEFAULT_ENFORCEMENT_DATE"; fi

          python scripts/evidence_kpi.py \
            --repo "${{ github.repository }}" \
            --base "$BASE" \
            --days "$DAYS" \
            --slice-days 7 \
            --slice-days 30 \
            --enforcement-date "$ENFORCEMENT_DATE" \
            --required-check lineage \
            --required-check assay-gate \
            --required-check assay-verify \
            --out-json "kpi/evidence-chain-kpi.json" \
            --out-md "kpi/evidence-chain-kpi.md"

      - name: Find previous successful KPI run
        id: find_prev
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          python - <<'PY'
          import json
          import os
          import urllib.parse
          import urllib.request

          token = os.environ["GITHUB_TOKEN"]
          repo = os.environ["GITHUB_REPOSITORY"]
          current_run_id = int(os.environ["GITHUB_RUN_ID"])
          owner, name = repo.split("/", 1)
          query = urllib.parse.urlencode(
              {
                  "branch": "main",
                  "status": "success",
                  "per_page": 30,
              }
          )
          url = (
              f"https://api.github.com/repos/{owner}/{name}/actions/workflows/"
              f"evidence-kpi.yml/runs?{query}"
          )
          req = urllib.request.Request(
              url=url,
              headers={
                  "Authorization": f"Bearer {token}",
                  "Accept": "application/vnd.github+json",
                  "X-GitHub-Api-Version": "2022-11-28",
                  "User-Agent": "agentmesh-evidence-kpi-history/1",
              },
              method="GET",
          )

          previous_run_id = ""
          try:
              with urllib.request.urlopen(req, timeout=30) as resp:
                  payload = json.loads(resp.read().decode("utf-8"))
              for run in payload.get("workflow_runs", []):
                  rid = int(run.get("id") or 0)
                  if rid and rid != current_run_id:
                      previous_run_id = str(rid)
                      break
          except Exception:
              previous_run_id = ""

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"previous_run_id={previous_run_id}\n")
          print(f"previous_run_id={previous_run_id or 'none'}")
          PY

      - name: Check previous KPI trend artifact availability
        id: has_prev_artifact
        if: steps.find_prev.outputs.previous_run_id != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PREVIOUS_RUN_ID: ${{ steps.find_prev.outputs.previous_run_id }}
        run: |
          python - <<'PY'
          import json
          import os
          import urllib.request

          token = os.environ["GITHUB_TOKEN"]
          repo = os.environ["GITHUB_REPOSITORY"]
          previous_run_id = os.environ["PREVIOUS_RUN_ID"]
          owner, name = repo.split("/", 1)
          url = f"https://api.github.com/repos/{owner}/{name}/actions/runs/{previous_run_id}/artifacts?per_page=100"
          req = urllib.request.Request(
              url=url,
              headers={
                  "Authorization": f"Bearer {token}",
                  "Accept": "application/vnd.github+json",
                  "X-GitHub-Api-Version": "2022-11-28",
                  "User-Agent": "agentmesh-evidence-kpi-history/1",
              },
              method="GET",
          )

          available = "false"
          try:
              with urllib.request.urlopen(req, timeout=30) as resp:
                  payload = json.loads(resp.read().decode("utf-8"))
              for artifact in payload.get("artifacts", []):
                  if str(artifact.get("name", "")) == "evidence-chain-kpi-history":
                      available = "true"
                      break
          except Exception:
              available = "false"

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"available={available}\n")
          print(f"previous_history_artifact_available={available}")
          PY

      - name: Download previous KPI trend artifact
        if: steps.find_prev.outputs.previous_run_id != '' && steps.has_prev_artifact.outputs.available == 'true'
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: evidence-chain-kpi-history
          path: .kpi-history
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          run-id: ${{ steps.find_prev.outputs.previous_run_id }}

      - name: Update KPI trend history
        env:
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GITHUB_WORKFLOW_NAME: ${{ github.workflow }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          from agentmesh.evidence_kpi import build_trend_point, merge_trend_history

          report_path = Path("kpi/evidence-chain-kpi.json")
          report = json.loads(report_path.read_text())

          history_file = None
          history_root = Path(".kpi-history")
          if history_root.exists():
              candidates = list(history_root.rglob("evidence-chain-kpi-history.jsonl"))
              if candidates:
                  history_file = candidates[0]

          existing = []
          if history_file and history_file.exists():
              for line in history_file.read_text().splitlines():
                  raw = line.strip()
                  if not raw:
                      continue
                  try:
                      item = json.loads(raw)
                  except json.JSONDecodeError:
                      continue
                  if isinstance(item, dict):
                      existing.append(item)

          point = build_trend_point(
              report,
              run_id=os.environ.get("GITHUB_RUN_ID", ""),
              run_attempt=os.environ.get("GITHUB_RUN_ATTEMPT", ""),
              run_url=os.environ.get("GITHUB_RUN_URL", ""),
              workflow=os.environ.get("GITHUB_WORKFLOW_NAME", ""),
              event_name=os.environ.get("GITHUB_EVENT_NAME", ""),
              ref_name=os.environ.get("GITHUB_REF_NAME", ""),
          )
          merged = merge_trend_history(existing, point, max_points=365)

          out_jsonl = Path("kpi/evidence-chain-kpi-history.jsonl")
          out_jsonl.parent.mkdir(parents=True, exist_ok=True)
          out_jsonl.write_text(
              "".join(json.dumps(item, sort_keys=True) + "\n" for item in merged)
          )

          lines = [
              "# Evidence KPI Trend (Last 14 Runs)",
              "",
              "| Generated | Primary | Since enforcement | Run |",
              "|---|---:|---:|---|",
          ]
          for item in reversed(merged[-14:]):
              generated = str(item.get("generated_at", ""))[:19] + "Z"
              primary = f"{item.get('passing_prs', 0)}/{item.get('ai_prs_total', 0)} ({item.get('coverage_pct', 0.0)}%)"
              since = (
                  f"{item.get('since_enforcement_passing_prs', 0)}/"
                  f"{item.get('since_enforcement_ai_prs_total', 0)} "
                  f"({item.get('since_enforcement_coverage_pct', 0.0)}%)"
              )
              run_url = str(item.get("run_url", ""))
              run_id = str(item.get("run_id", ""))
              run_link = f"[{run_id}]({run_url})" if run_id and run_url else run_id
              lines.append(f"| {generated} | {primary} | {since} | {run_link} |")

          Path("kpi/evidence-chain-kpi-history.md").write_text("\n".join(lines) + "\n")
          print(f"trend_points={len(merged)}")
          PY

      - name: Add summary
        if: always()
        run: |
          if [ -f kpi/evidence-chain-kpi.md ]; then
            cat kpi/evidence-chain-kpi.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No KPI markdown produced." >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ -f kpi/evidence-chain-kpi-history.md ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            cat kpi/evidence-chain-kpi-history.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload KPI artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence-chain-kpi
          path: kpi/

      - name: Upload KPI trend artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence-chain-kpi-history
          path: |
            kpi/evidence-chain-kpi-history.jsonl
            kpi/evidence-chain-kpi-history.md
