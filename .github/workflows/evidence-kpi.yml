name: Evidence KPI

on:
  schedule:
    - cron: "17 4 * * *"
  workflow_dispatch:
    inputs:
      days:
        description: "Lookback window in days"
        required: false
        default: "30"
      base:
        description: "Base branch"
        required: false
        default: "main"
      enforcement_date:
        description: "Enforcement start date (YYYY-MM-DD)"
        required: false
        default: "2026-02-24"

permissions:
  contents: read
  pull-requests: read
  checks: read

jobs:
  evidence-kpi:
    runs-on: ubuntu-latest
    env:
      DEFAULT_ENFORCEMENT_DATE: "2026-02-24"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Compute evidence KPI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DAYS="${{ github.event.inputs.days }}"
          BASE="${{ github.event.inputs.base }}"
          ENFORCEMENT_DATE="${{ github.event.inputs.enforcement_date }}"
          if [ -z "$DAYS" ]; then DAYS="30"; fi
          if [ -z "$BASE" ]; then BASE="main"; fi
          if [ -z "$ENFORCEMENT_DATE" ]; then ENFORCEMENT_DATE="$DEFAULT_ENFORCEMENT_DATE"; fi

          python scripts/evidence_kpi.py \
            --repo "${{ github.repository }}" \
            --base "$BASE" \
            --days "$DAYS" \
            --slice-days 7 \
            --slice-days 30 \
            --enforcement-date "$ENFORCEMENT_DATE" \
            --required-check lineage \
            --required-check assay-gate \
            --required-check assay-verify \
            --out-json "kpi/evidence-chain-kpi.json" \
            --out-md "kpi/evidence-chain-kpi.md"

      - name: Add summary
        if: always()
        run: |
          if [ -f kpi/evidence-chain-kpi.md ]; then
            cat kpi/evidence-chain-kpi.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No KPI markdown produced." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload KPI artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence-chain-kpi
          path: kpi/
